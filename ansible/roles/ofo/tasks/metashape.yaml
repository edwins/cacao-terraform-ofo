---
- name: SHELL ; grab metashape-pro_2_0_0_amd64.tar.gz, unzip, mv to bin
  become: true
  unarchive:
    src: "{{ METASHAPE_PRO_URL }}"
    dest: /opt
    remote_src: yes

- name: GET_URL ; grab metashape_icon.jpg
  become: true
  get_url:
    url: "{{ METASHAPE_PRO_ICON_URL }}"
    dest: /opt/metashape-pro/metashape_icon.jpg

- name: COPY ; copy metashape.desktop
  become: true
  copy:
    src: metashape.desktop
    dest: /usr/share/applications/metashape.desktop

- name: FILE ; ensure correct perms for metashape-pro directory
  become: true
  file:
    path: /opt/metashape-pro
    owner: ubuntu
    group: ubuntu
    recurse: yes

- name: APT ; install libxcb-xinerama0
  become: true
  apt:
    name: libxcb-xinerama0
    state: present

- name: FILE ; ensure the license directory exists
  file:
    path: /opt/metashape-pro/metashape_lic
    state: directory
    mode: '0750'

- name: TEMPLATE ; template the license files
  template:
    src: "license.j2"
    dest: /opt/metashape-pro/metashape_lic/{{ item.dest }}
    mode: 0600
  loop:
    - { dest: 'primary.lic', license: '{{ PRIMARY_METASHAPE_LICENSE }}'}
    - { dest: 'secondary.lic', license: '{{ SECONDARY_METASHAPE_LICENSE }}'}

- name: LINEINFILE ; ensure agisoft_LICENSE in .bashrc
  ansible.builtin.lineinfile:
    path: ~/.bashrc
    line: 'export agisoft_LICENSE="/opt/metashape-pro/metashape_lic/"'

- name: LINEINFILE ; ensure agisoft_LICENSE in .profile
  ansible.builtin.lineinfile:
    path: ~/.profile
    line: 'export agisoft_LICENSE="/opt/metashape-pro/metashape_lic/"'

- name: SHELL ; run conda activate and pip for metashape20
  shell:
    cmd: "~/anaconda3/bin/conda run -n metashape20 pip install {{ METASHAPE_PRO_WHL_MODULE }}"
  args:
    executable: /bin/bash
