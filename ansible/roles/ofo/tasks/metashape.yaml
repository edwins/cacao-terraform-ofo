---
- name: SHELL ; grab metashape-pro_2_0_0_amd64.tar.gz, unzip, mv to bin
  become: true
  unarchive:
    src: https://s3-eu-west-1.amazonaws.com/download.agisoft.com/metashape-pro_2_0_0_amd64.tar.gz
    dest: /opt
    remote_src: yes

- name: GET_URL ; grab metashape_icon.jpg
  become: true
  get_url:
    url: https://yt3.ggpht.com/ytc/AMLnZu_dMjWqf8JdyAiiVaYhv5DdGECBlHd9MnSv9uQQtw=s176-c-k-c0x00ffffff-no-rj
    dest: /opt/metashape-pro/metashape_icon.jpg

- name: COPY ; copy metashape.desktop
  become: true
  copy:
    src: metashape.desktop
    dest: /usr/share/applications/metashape.desktop

- name: FILE ; ensure correct perms for metashape-pro directory
  become: true
  file:
    path: /opt/metashape-pro
    owner: ubuntu
    group: ubuntu
    recurse: yes

- name: APT ; install libxcb-xinerama0
  become: true
  apt:
    name: libxcb-xinerama0
    state: present

- name: FILE ; ensure the license directory exists
  file:
    path: /opt/metashape-pro/metashape_lic
    state: directory
    mode: '0750'

- name: TEMPLATE ; template the license files
  template:
    src: "license.j2"
    dest: /opt/metashape-pro/metashape_lic/{{ item.dest }}
    mode: 0600
  loop:
    - { dest: 'primary.lic', license: '{{ PRIMARY_METASHAPE_LICENSE }}'}
    - { dest: 'secondary.lic', license: '{{ SECONDARY_METASHAPE_LICENSE }}'}

- name: LINEINFILE ; ensure agisoft_LICENSE in .bashrc
  ansible.builtin.lineinfile:
    path: ~/.bashrc
    line: 'export agisoft_LICENSE="/opt/metashape-pro/metashape_lic/"'

- name: LINEINFILE ; ensure agisoft_LICENSE in .profile
  ansible.builtin.lineinfile:
    path: ~/.profile
    line: 'export agisoft_LICENSE="/opt/metashape-pro/metashape_lic/"'

- name: SHELL ; run conda activate and pip for meta200
  shell:
    cmd: ~/anaconda3/bin/conda run -n meta200 pip install https://s3-eu-west-1.amazonaws.com/download.agisoft.com/Metashape-2.0.0-cp35.cp36.cp37.cp38-abi3-linux_x86_64.whl
  args:
    executable: /bin/bash
